<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Malla Curricular - Plan Base Estudio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    /* LOGIN SCREEN */
    .login-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 80vh;
      padding: 40px;
    }

    .login-box {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      max-width: 500px;
      width: 100%;
      text-align: center;
    }

    .logo-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 25px;
    }

    .logo-peb {
      width: 80px;
      height: 80px;
      object-fit: contain;
    }

    .titulo-empresa {
      font-family: 'Oswald', sans-serif;
      font-weight: 700;
      font-size: 2.2em;
      color: #1e3a8a;
      letter-spacing: 0.5px;
    }

    .login-box h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 1.5em;
      font-weight: 600;
    }

    .login-box p {
      color: #666;
      margin-bottom: 30px;
    }

    .login-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 1.2em;
      text-align: center;
      font-family: 'Courier New', monospace;
      transition: all 0.3s;
      margin-bottom: 20px;
    }

    .login-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
    }

    .login-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 40px;
      border: none;
      border-radius: 10px;
      font-size: 1.2em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      width: 100%;
    }

    .login-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .loading {
      color: #667eea;
      padding: 20px;
      font-size: 1.1em;
    }

    .error-mensaje {
      background: #ffebee;
      border: 2px solid #f44336;
      color: #c62828;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    /* MALLA SCREEN */
    .malla-screen {
      display: none;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px 30px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo-peb-small {
      width: 60px;
      height: 60px;
      object-fit: contain;
    }

    .header-info h1 {
      font-family: 'Oswald', sans-serif;
      font-weight: 700;
      font-size: 1.8em;
      margin-bottom: 5px;
      letter-spacing: 0.5px;
    }

    .header-info p {
      opacity: 0.9;
      font-size: 0.95em;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .whatsapp-link {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(37, 211, 102, 0.2);
      padding: 8px 15px;
      border-radius: 10px;
      color: white;
      text-decoration: none;
      transition: all 0.3s;
      backdrop-filter: blur(10px);
    }

    .whatsapp-link:hover {
      background: rgba(37, 211, 102, 0.4);
      transform: translateY(-2px);
    }

    .whatsapp-icon {
      font-size: 1.5em;
    }

    .btn-logout {
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 10px 20px;
      border: 2px solid white;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      border: none;
    }

    .btn-logout:hover {
      background: white;
      color: #667eea;
    }

    .content {
      padding: 30px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #e0e0e0;
      flex-wrap: wrap;
    }

    .tab {
      padding: 15px 30px;
      background: #f5f5f5;
      border: none;
      border-radius: 10px 10px 0 0;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.1em;
      transition: all 0.3s;
      color: #666;
    }

    .tab:hover {
      background: #e0e0e0;
    }

    .tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* NIVELES VISIBLES Y CONTROLES */
    .niveles-visibles {
      background: #f9f9f9;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .niveles-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .niveles-header h3 {
      color: #667eea;
      margin: 0;
    }

    .botones-control {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-control {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      font-size: 0.95em;
    }

    .btn-guardar-top {
      background: #4caf50;
      color: white;
    }

    .btn-guardar-top:hover {
      background: #45a049;
      transform: translateY(-2px);
    }

    .btn-toggle-creditos-global {
      background: #2196f3;
      color: white;
    }

    .btn-toggle-creditos-global:hover {
      background: #1976d2;
      transform: translateY(-2px);
    }

    .niveles-checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    .nivel-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nivel-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .nivel-checkbox label {
      cursor: pointer;
      font-weight: 600;
      color: #333;
    }

    /* GRID DE NIVELES */
    .niveles-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .nivel-section {
      break-inside: avoid;
    }

    .nivel-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 15px;
      border-radius: 10px 10px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .nivel-header h2 {
      margin: 0;
      font-size: 1.1em;
    }

    .year-selector {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.2);
      padding: 6px 12px;
      border-radius: 8px;
    }

    .year-selector button {
      background: white;
      color: #667eea;
      border: none;
      padding: 4px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
      font-size: 0.85em;
    }

    .year-selector button:hover {
      background: #f0f0f0;
    }

    .year-selector span {
      font-size: 0.95em;
      font-weight: bold;
      min-width: 45px;
      text-align: center;
    }

    /* CURSOS - Espacios optimizados */
    .cursos-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      padding: 12px;
      background: #f9f9f9;
      border-radius: 0 0 10px 10px;
    }

    .curso-card {
      background: white;
      padding: 10px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .curso-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .curso-card.aprobado {
      border-color: #2196f3;
      background: #e3f2fd;
    }

    .curso-card.actual {
      border-color: #4caf50;
      background: #e8f5e9;
    }

    .curso-card.proximo {
      border-color: #ff9800;
      background: #fff3e0;
    }

    .curso-card.subsiguiente {
      border-color: #e91e63;
      background: #fce4ec;
    }

    .curso-card.futuro {
      border-color: #ffc107;
      background: #fff9c4;
    }

    .curso-nombre {
      font-weight: 600;
      font-size: 0.95em;
      color: #333;
      margin-bottom: 6px;
      padding: 4px;
      border-radius: 5px;
      transition: background 0.3s;
      line-height: 1.3;
    }

    .curso-nombre:focus {
      outline: none;
      background: #fff9c4;
    }

    .curso-creditos {
      color: #666;
      margin-bottom: 6px;
      padding: 2px 4px;
      border-radius: 5px;
      transition: background 0.3s;
      font-size: 0.85em;
    }

    .curso-creditos:focus {
      outline: none;
      background: #fff9c4;
    }

    .curso-estado {
      width: 100%;
      padding: 6px 8px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 0.85em;
      cursor: pointer;
      background: white;
      transition: all 0.3s;
      margin-top: 0;
    }

    .curso-estado:focus {
      outline: none;
      border-color: #667eea;
    }

    /* ELECTIVOS */
    .electivos-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 0 0 10px 10px;
    }

    .curso-card-electivo {
      background: white;
      padding: 10px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .curso-card-electivo:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* PLANEADOS - Usa mismo grid que obligatorios */
    .curso-planeado-actions {
      display: flex;
      flex-direction: row;
      gap: 6px;
      margin-top: 8px;
    }

    .btn-mover {
      padding: 6px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      font-size: 0.75em;
      text-align: center;
      flex: 1;
    }

    .btn-mover-prev {
      background: #e3f2fd;
      color: #1976d2;
    }

    .btn-mover-prev:hover {
      background: #1976d2;
      color: white;
    }

    .btn-mover-next {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .btn-mover-next:hover {
      background: #2e7d32;
      color: white;
    }

    .btn-quitar {
      background: #ffebee;
      color: #c62828;
    }

    .btn-quitar:hover {
      background: #c62828;
      color: white;
    }

    .footer {
      display: none;
    }

    .guardado-mensaje {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #4caf50;
      color: white;
      padding: 20px 30px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      font-weight: 600;
      font-size: 1.1em;
      animation: slideIn 0.3s;
      z-index: 1000;
    }

    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* RESPONSIVE */
    @media (max-width: 1400px) {
      .niveles-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      .electivos-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 1024px) {
      .niveles-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .electivos-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      .header-left {
        width: 100%;
      }

      .header-right {
        width: 100%;
        justify-content: space-between;
      }

      .whatsapp-link {
        flex: 1;
      }

      .btn-logout {
        flex: 1;
      }

      .nivel-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .botones-control {
        width: 100%;
      }

      .btn-control {
        flex: 1;
      }

      .logo-peb {
        width: 60px;
        height: 60px;
      }

      .titulo-empresa {
        font-size: 1.5em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loginScreen" class="login-screen">
      <div class="login-box">
        <div class="logo-container">
          <img src="https://lh3.googleusercontent.com/d/1R9ePK1eubwwyQYv2WRUoYPupIQPN2t7r" alt="Logo PEB" class="logo-peb">
          <div class="titulo-empresa">Plan Base Estudio</div>
        </div>
        
        <h1>üéì Acceso a Mi Malla Curricular</h1>
        <p>Ingresa tu c√≥digo de estudiante</p>
        <input type="text" id="codigoInput" class="login-input" placeholder="Ej: abcdef1" onkeypress="if(event.key === 'Enter') buscarMalla()">
        <button class="login-button" onclick="buscarMalla()">üîì Acceder</button>
        <div id="loginMensaje"></div>
      </div>
    </div>

    <div id="mallaScreen" class="malla-screen">
      <div class="header">
        <div class="header-left">
          <img src="https://lh3.googleusercontent.com/d/1R9ePK1eubwwyQYv2WRUoYPupIQPN2t7r" alt="Logo PEB" class="logo-peb-small">
          <div class="header-info">
            <h1>Plan Base Estudio</h1>
            <p id="headerNombre">Cargando...</p>
            <p id="headerInfo" style="font-size: 0.85em; opacity: 0.8;">Cargando...</p>
          </div>
        </div>
        <div class="header-right">
          <a href="https://wa.me/51997888530" target="_blank" class="whatsapp-link">
            <span class="whatsapp-icon">üí¨</span>
            <span>(+51) 997 888 530</span>
          </a>
          <button class="btn-logout" onclick="cerrarSesion()">üö™ Salir</button>
        </div>
      </div>

      <div class="content">
        <div class="tabs">
          <button class="tab active" onclick="cambiarVista('obligatorios')">üìñ Cursos Obligatorios</button>
          <button class="tab" onclick="cambiarVista('electivos')">‚≠ê Cursos Electivos</button>
          <button class="tab" onclick="cambiarVista('planeados')">üìÖ Cursos Planeados</button>
        </div>

        <div id="obligatorios" class="tab-content active"></div>
        <div id="electivos" class="tab-content"></div>
        <div id="planeados" class="tab-content"></div>
      </div>

      <div class="footer"></div>
    </div>
  </div>

  <script>
    let studentCode = '';
    let studentData = null;
    let mallaCursos = [];
    let nivelesVisibles = new Set();
    let cambiosPendientes = [];
    let mostrarCreditos = true;

    window.onload = function() {
      document.getElementById('codigoInput').focus();
    };

    function buscarMalla() {
      const codigo = document.getElementById('codigoInput').value.trim().toLowerCase();
      
      if (!codigo) {
        mostrarMensajeLogin('Por favor ingresa tu c√≥digo', 'error');
        return;
      }

      mostrarMensajeLogin('üîç Buscando...', 'loading');

      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.success) {
            studentCode = codigo;
            studentData = result;
            cargarMalla();
          } else {
            mostrarMensajeLogin('‚ùå C√≥digo no encontrado', 'error');
          }
        })
        .withFailureHandler(function(error) {
          mostrarMensajeLogin('‚ùå Error: ' + error.message, 'error');
        })
        .obtenerDatosEstudiante(codigo);
    }

    function mostrarMensajeLogin(mensaje, tipo) {
      const div = document.getElementById('loginMensaje');
      div.className = tipo === 'error' ? 'error-mensaje' : 'loading';
      div.innerHTML = mensaje;
    }

    function cargarMalla() {
      google.script.run
        .withSuccessHandler(function(cursos) {
          mallaCursos = cursos;
                  
          const niveles = [...new Set(cursos.map(c => c.nivel))];
          niveles.forEach(nivel => {
            const primerCurso = cursos.find(c => c.nivel === nivel);
            if (primerCurso && primerCurso.visible === 'visible') {
            nivelesVisibles.add(nivel);  // Solo si dice "visible"
            }
          });
          
          mostrarPantallaMalla();
        })
        .withFailureHandler(function(error) {
          mostrarMensajeLogin('‚ùå Error al cargar: ' + error.message, 'error');
        })
        .obtenerMallaEstudiante(studentCode);
    }

    function mostrarPantallaMalla() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mallaScreen').style.display = 'block';
      
      document.getElementById('headerNombre').textContent = studentData.nombre;
      document.getElementById('headerInfo').textContent = studentData.instituto + ' - ' + studentData.carrera;
      
      renderizarPagina();
    }

    function cerrarSesion() {
      if (cambiosPendientes.length > 0) {
        if (!confirm('Tienes cambios sin guardar. ¬øSeguro que deseas salir?')) {
          return;
        }
      }
      
      studentCode = '';
      studentData = null;
      mallaCursos = [];
      nivelesVisibles.clear();
      cambiosPendientes = [];
      
      document.getElementById('mallaScreen').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('codigoInput').value = '';
      document.getElementById('loginMensaje').innerHTML = '';
      document.getElementById('codigoInput').focus();
    }

    function renderizarPagina() {
      renderizarCursosObligatorios();
      renderizarCursosElectivos();
      renderizarCursosPlaneados();
    }

    function cambiarVista(vista) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(vista).classList.add('active');
    }

    function renderizarNivelesVisibles(contenedorId) {
      const niveles = [...new Set(mallaCursos.map(c => c.nivel))]
        .filter(n => !n.toLowerCase().includes('electivo'))
        .sort((a, b) => {
          const numA = parseInt(a.match(/\d+/)?.[0] || 0);
          const numB = parseInt(b.match(/\d+/)?.[0] || 0);
          return numA - numB;
        });
      
      const html = `
        <div class="niveles-visibles">
          <div class="niveles-header">
            <h3>üîç Niveles Visibles</h3>
            <div class="botones-control">
              <button class="btn-control btn-guardar-top" onclick="guardarCambios()">üíæ Guardar Cambios</button>
              <button class="btn-control btn-toggle-creditos-global" onclick="toggleCreditos()">${mostrarCreditos ? 'üôà Ocultar' : 'üëÅÔ∏è Mostrar'} Cr√©ditos</button>
            </div>
          </div>
          <div class="niveles-checkboxes">
            ${niveles.map(nivel => `
              <div class="nivel-checkbox">
                <input type="checkbox" id="nivel-${nivel}" ${nivelesVisibles.has(nivel) ? 'checked' : ''} onchange="toggleNivelVisible('${nivel}')">
                <label for="nivel-${nivel}">${nivel}</label>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      document.getElementById(contenedorId).insertAdjacentHTML('afterbegin', html);
    }

    function toggleNivelVisible(nivel) {
      if (nivelesVisibles.has(nivel)) {
        nivelesVisibles.delete(nivel);
        google.script.run.actualizarVisibilidadNivel(studentCode, nivel, false);
      } else {
        nivelesVisibles.add(nivel);
        google.script.run.actualizarVisibilidadNivel(studentCode, nivel, true);
      }
      renderizarPagina();
    }

    function toggleCreditos() {
      mostrarCreditos = !mostrarCreditos;
      renderizarPagina();
    }

    function renderizarCursosObligatorios() {
      const contenedor = document.getElementById('obligatorios');
      const cursosObligatorios = mallaCursos.filter(c => !c.nivel.toLowerCase().includes('electivo'));
      
      if (cursosObligatorios.length === 0) {
        contenedor.innerHTML = '<p class="error-mensaje">No hay cursos obligatorios</p>';
        return;
      }
      
      const niveles = [...new Set(cursosObligatorios.map(c => c.nivel))].sort((a, b) => {
        const numA = parseInt(a.match(/\d+/)?.[0] || 0);
        const numB = parseInt(b.match(/\d+/)?.[0] || 0);
        return numA - numB;
      });
      
      let html = '<div class="niveles-grid">';
      
      niveles.forEach(nivel => {
        if (!nivelesVisibles.has(nivel)) return;
        
        const cursos = cursosObligatorios.filter(c => c.nivel === nivel);
        const anioActual = new Date().getFullYear();
        
        // Verificar si todos los cursos del nivel est√°n aprobados
        const todosAprobados = cursos.every(curso => {
          if (curso.estado === 'OK') return true;
          if (curso.estado && curso.estado.includes('-')) {
            const diferencia = calcularDiferenciaCiclo(curso.estado);
            return diferencia < 0; // Ciclo pasado = aprobado
          }
          return false;
        });
        
        const estrella = todosAprobados ? ' ‚≠ê' : '';
        
        html += `
          <div class="nivel-section">
            <div class="nivel-header">
              <h2>${nivel}${estrella}</h2>
              <div class="year-selector">
                <button onclick="cambiarAnio('${nivel}', -1)">‚óÄ</button>
                <span id="year-${nivel}">${anioActual}</span>
                <button onclick="cambiarAnio('${nivel}', 1)">‚ñ∂</button>
              </div>
            </div>
            <div class="cursos-grid">
              ${cursos.map(curso => {
                const claseColor = obtenerClaseColor(curso.estado);
                const anioEstado = curso.estado && curso.estado.includes('-') ? curso.estado.split('-')[0] : anioActual;
                return `
                  <div class="curso-card ${claseColor}" data-fila="${curso.fila}" data-nivel="${nivel}">
                    <div class="curso-nombre" contenteditable="true" onblur="editarCurso(${curso.fila}, this.textContent)">${curso.curso}</div>
                    ${mostrarCreditos ? `<div class="curso-creditos" contenteditable="true" onblur="editarCreditos(${curso.fila}, this.textContent)">üìö ${curso.creditos} cr√©ditos</div>` : ''}
                    <select class="curso-estado" data-fila="${curso.fila}" onchange="cambiarEstado(${curso.fila}, '${nivel}', this.value)">
                      ${generarOpcionesEstado(nivel, anioEstado, curso.estado)}
                    </select>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      contenedor.innerHTML = html;
      renderizarNivelesVisibles('obligatorios');
    }

    function generarOpcionesEstado(nivel, anioOpciones, estadoActual) {
      const opciones = [
        { valor: '', texto: '‚ö™ Sin estado' },
        { valor: 'OK', texto: '‚úÖ Aprobado' },
        { valor: `${anioOpciones}-0`, texto: `üìò ${anioOpciones}-0 (Verano)` },
        { valor: `${anioOpciones}-1`, texto: `üìô ${anioOpciones}-1 (Sem 1)` },
        { valor: `${anioOpciones}-2`, texto: `üìó ${anioOpciones}-2 (Sem 2)` }
      ];
      
      return opciones.map(opcion => 
        `<option value="${opcion.valor}" ${estadoActual === opcion.valor ? 'selected' : ''}>${opcion.texto}</option>`
      ).join('');
    }

    function cambiarAnio(nivel, incremento) {
      const yearSpan = document.getElementById(`year-${nivel}`);
      const anioActual = parseInt(yearSpan.textContent);
      const nuevoAnio = anioActual + incremento;
      yearSpan.textContent = nuevoAnio;
      
      const cursos = document.querySelectorAll(`.curso-card[data-nivel="${nivel}"]`);
      cursos.forEach(cursoCard => {
        const select = cursoCard.querySelector('.curso-estado');
        const estadoActual = select.value;
        
        if (!estadoActual || estadoActual === '' || estadoActual === 'OK') {
          select.innerHTML = generarOpcionesEstado(nivel, nuevoAnio, estadoActual);
        }
      });
    }

    function renderizarCursosElectivos() {
      const contenedor = document.getElementById('electivos');
      const cursosElectivos = mallaCursos.filter(c => c.nivel.toLowerCase().includes('electivo'));
      
      if (cursosElectivos.length === 0) {
        contenedor.innerHTML = '<p class="error-mensaje">No hay cursos electivos</p>';
        return;
      }
      
      const anioActual = new Date().getFullYear();
      
      let html = `
        <div class="nivel-section">
          <div class="nivel-header">
            <h2>‚≠ê Cursos Electivos</h2>
            <div class="year-selector">
              <button onclick="cambiarAnioElectivos(-1)">‚óÄ</button>
              <span id="year-electivos">${anioActual}</span>
              <button onclick="cambiarAnioElectivos(1)">‚ñ∂</button>
            </div>
          </div>
          <div class="electivos-grid" id="electivos-container">
      `;
      
      cursosElectivos.forEach(curso => {
        const claseColor = obtenerClaseColor(curso.estado);
        const anioEstado = curso.estado && curso.estado.includes('-') ? curso.estado.split('-')[0] : anioActual;
        html += `
          <div class="curso-card-electivo ${claseColor}" data-fila="${curso.fila}">
            <div class="curso-nombre" contenteditable="true" onblur="editarCurso(${curso.fila}, this.textContent)">${curso.curso}</div>
            ${mostrarCreditos ? `<div class="curso-creditos" contenteditable="true" onblur="editarCreditos(${curso.fila}, this.textContent)">üìö ${curso.creditos} cr√©ditos</div>` : ''}
            <select class="curso-estado" data-fila="${curso.fila}" onchange="cambiarEstado(${curso.fila}, 'Electivo', this.value)">
              ${generarOpcionesEstado('Electivo', anioEstado, curso.estado)}
            </select>
          </div>
        `;
      });
      
      html += '</div></div>';
      contenedor.innerHTML = html;
    }

    function cambiarAnioElectivos(incremento) {
      const yearSpan = document.getElementById('year-electivos');
      const anioActual = parseInt(yearSpan.textContent);
      const nuevoAnio = anioActual + incremento;
      yearSpan.textContent = nuevoAnio;
      
      const electivosContainer = document.getElementById('electivos-container');
      const selects = electivosContainer.querySelectorAll('.curso-estado');
      
      selects.forEach(select => {
        const estadoActual = select.value;
        if (!estadoActual || estadoActual === '' || estadoActual === 'OK') {
          select.innerHTML = generarOpcionesEstado('Electivo', nuevoAnio, estadoActual);
        }
      });
    }

    function renderizarCursosPlaneados() {
      const contenedor = document.getElementById('planeados');
      
      const cursosPlaneados = mallaCursos.filter(c => {
        if (!c.estado || c.estado === 'OK' || c.estado === '' || !c.estado.includes('-')) return false;
        
        const diferencia = calcularDiferenciaCiclo(c.estado);
        return diferencia >= 0;
      });
      
      if (cursosPlaneados.length === 0) {
        contenedor.innerHTML = '<p class="error-mensaje">No hay cursos planeados a√∫n. Marca cursos con ciclos futuros en las otras pesta√±as.</p>';
        return;
      }
      
      const ciclos = [...new Set(cursosPlaneados.map(c => c.estado))].sort();
      
      let html = '<h2 style="color: #667eea; margin-bottom: 20px;">üìÖ Mis Cursos Planeados</h2>';
      html += '<div class="niveles-grid">';
      
      ciclos.forEach(ciclo => {
        const cursos = cursosPlaneados.filter(c => c.estado === ciclo);
        const totalCreditos = cursos.reduce((sum, c) => sum + (parseInt(c.creditos) || 0), 0);
        
        // Determinar nombre del ciclo
        const [anio, numCiclo] = ciclo.split('-');
        let nombreCiclo = '';
        if (numCiclo === '0') nombreCiclo = `Verano ${anio}`;
        else if (numCiclo === '1') nombreCiclo = `${anio}-1`;
        else if (numCiclo === '2') nombreCiclo = `${anio}-2`;
        
        html += `
          <div class="nivel-section">
            <div class="nivel-header" style="margin-bottom: 0;">
              <h2>üìò ${nombreCiclo}</h2>
              <span style="background: rgba(255,255,255,0.3); padding: 8px 15px; border-radius: 8px; font-size: 0.9em;">üìö ${totalCreditos} cr√©ditos</span>
            </div>
            <div class="cursos-grid">
              ${cursos.map(curso => `
                <div class="curso-card" style="border-left: 4px solid #2196f3;">
                  <div class="curso-nombre" style="font-size: 0.9em; margin-bottom: 8px;">${curso.curso}</div>
                  <div style="color: #666; font-size: 0.8em; margin-bottom: 10px;">${curso.nivel} ‚Ä¢ ${curso.creditos} cr√©ditos</div>
                  <div class="curso-planeado-actions">
                    <button class="btn-mover btn-mover-prev" onclick="moverCursoPlaneado(${curso.fila}, '${ciclo}', -1)">‚¨ÖÔ∏è Anterior</button>
                    <button class="btn-mover btn-quitar" onclick="quitarDePlaneados(${curso.fila})">‚ùå Quitar</button>
                    <button class="btn-mover btn-mover-next" onclick="moverCursoPlaneado(${curso.fila}, '${ciclo}', 1)">Siguiente ‚û°Ô∏è</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      contenedor.innerHTML = html;
    }

    function calcularDiferenciaCiclo(estado) {
      const ahora = new Date();
      const anioActual = ahora.getFullYear();
      const mesActual = ahora.getMonth() + 1; // 1-12
      const diaActual = ahora.getDate();
      
      let cicloActual;
      // Ciclo 0 (Verano): 01/01 a 01/03
      if ((mesActual === 1) || (mesActual === 2) || (mesActual === 3 && diaActual === 1)) {
        cicloActual = 0;
      }
      // Ciclo 1 (Semestre 1): 02/03 a 01/08
      else if ((mesActual === 3 && diaActual > 1) || (mesActual >= 4 && mesActual <= 7) || (mesActual === 8 && diaActual === 1)) {
        cicloActual = 1;
      }
      // Ciclo 2 (Semestre 2): 02/08 a 01/12
      else if ((mesActual === 8 && diaActual > 1) || (mesActual >= 9 && mesActual <= 11) || (mesActual === 12 && diaActual === 1)) {
        cicloActual = 2;
      }
      // Despu√©s del 01/12: Ya estamos en el pr√≥ximo a√±o ciclo 0
      else if (mesActual === 12 && diaActual > 1) {
        cicloActual = 0;
        // Pero como a√∫n no cambi√≥ el a√±o, mantenemos el a√±o actual para el c√°lculo
        // y luego ajustamos
      }
      
      const partes = estado.split('-');
      if (partes.length !== 2) return -999;
      
      const anioCurso = parseInt(partes[0]);
      const cicloCurso = parseInt(partes[1]);
      
      // Ajuste especial para diciembre despu√©s del d√≠a 1
      let anioBase = anioActual;
      if (mesActual === 12 && diaActual > 1) {
        // Estamos en diciembre despu√©s del d√≠a 1, consideramos que estamos en el siguiente a√±o ciclo 0
        anioBase = anioActual + 1;
      }
      
      const ciclosTotalesActual = anioBase * 3 + cicloActual;
      const ciclosTotalesCurso = anioCurso * 3 + cicloCurso;
      
      return ciclosTotalesCurso - ciclosTotalesActual;
    }

    function moverCursoPlaneado(fila, cicloActual, direccion) {
      const [anio, ciclo] = cicloActual.split('-').map(n => parseInt(n));
      let nuevoCiclo = ciclo + direccion;
      let nuevoAnio = anio;
      
      if (nuevoCiclo < 0) {
        nuevoCiclo = 2;
        nuevoAnio = anio - 1;
      } else if (nuevoCiclo > 2) {
        nuevoCiclo = 0;
        nuevoAnio = anio + 1;
      }
      
      const nuevoEstado = `${nuevoAnio}-${nuevoCiclo}`;
      
      const curso = mallaCursos.find(c => c.fila === fila);
      if (curso) {
        curso.estado = nuevoEstado;
        cambiosPendientes.push({ fila: fila, estado: nuevoEstado });
        
        actualizarEstadoEnOtrasPestanas(fila, nuevoEstado);
        renderizarCursosPlaneados();
      }
    }

    function quitarDePlaneados(fila) {
      const curso = mallaCursos.find(c => c.fila === fila);
      if (curso) {
        curso.estado = '';
        cambiosPendientes.push({ fila: fila, estado: '' });
        
        actualizarEstadoEnOtrasPestanas(fila, '');
        renderizarCursosPlaneados();
      }
    }

    function actualizarEstadoEnOtrasPestanas(fila, nuevoEstado) {
      const selects = document.querySelectorAll(`.curso-estado[data-fila="${fila}"]`);
      selects.forEach(select => {
        select.value = nuevoEstado;
        const card = select.closest('.curso-card, .curso-card-electivo');
        if (card) {
          const baseClass = card.classList.contains('curso-card') ? 'curso-card' : 'curso-card-electivo';
          card.className = baseClass + ' ' + obtenerClaseColor(nuevoEstado);
        }
      });
    }

    function editarCurso(fila, nuevoNombre) {
      const curso = mallaCursos.find(c => c.fila === fila);
      if (curso && nuevoNombre.trim() !== '') {
        curso.curso = nuevoNombre.trim();
        cambiosPendientes.push({ fila: fila, curso: nuevoNombre.trim() });
      }
    }

    function editarCreditos(fila, nuevoTexto) {
      const match = nuevoTexto.match(/\d+/);
      if (match) {
        const creditos = parseInt(match[0]);
        const curso = mallaCursos.find(c => c.fila === fila);
        if (curso) {
          curso.creditos = creditos;
          cambiosPendientes.push({ fila: fila, creditos: creditos });
        }
      }
    }

    function cambiarEstado(fila, nivel, nuevoEstado) {
      const curso = mallaCursos.find(c => c.fila === fila);
      if (curso) {
        curso.estado = nuevoEstado;
        cambiosPendientes.push({ fila: fila, estado: nuevoEstado });
        
        const cards = document.querySelectorAll(`[data-fila="${fila}"]`);
        cards.forEach(card => {
          if (card.classList.contains('curso-card') || card.classList.contains('curso-card-electivo')) {
            const baseClass = card.classList.contains('curso-card') ? 'curso-card' : 'curso-card-electivo';
            card.className = baseClass + ' ' + obtenerClaseColor(nuevoEstado);
          }
        });
        
        renderizarCursosPlaneados();
      }
    }

    function guardarCambios() {
      if (cambiosPendientes.length === 0) {
        alert('No hay cambios pendientes para guardar');
        return;
      }
      
      const btnGuardar = document.querySelector('.btn-guardar-top');
      const textoOriginal = btnGuardar.textContent;
      btnGuardar.textContent = '‚è≥ Guardando...';
      btnGuardar.disabled = true;
      
      const cambiosConsolidados = [];
      const filasProcesadas = new Set();
      
      cambiosPendientes.forEach(cambio => {
        if (!filasProcesadas.has(cambio.fila)) {
          const cambiosFila = cambiosPendientes.filter(c => c.fila === cambio.fila);
          const cambioConsolidado = { fila: cambio.fila };
          
          cambiosFila.forEach(c => {
            if (c.curso !== undefined) cambioConsolidado.curso = c.curso;
            if (c.creditos !== undefined) cambioConsolidado.creditos = c.creditos;
            if (c.estado !== undefined) cambioConsolidado.estado = c.estado;
          });
          
          cambiosConsolidados.push(cambioConsolidado);
          filasProcesadas.add(cambio.fila);
        }
      });
      
      google.script.run
        .withSuccessHandler(function(result) {
          btnGuardar.textContent = textoOriginal;
          btnGuardar.disabled = false;
          
          if (result.success) {
            cambiosPendientes = [];
            mostrarGuardado();
          } else {
            alert('Error al guardar: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          btnGuardar.textContent = textoOriginal;
          btnGuardar.disabled = false;
          alert('Error de conexi√≥n: ' + error.message);
        })
        .guardarCambiosMalla(studentCode, cambiosConsolidados);
    }

    function mostrarGuardado() {
      const mensaje = document.createElement('div');
      mensaje.className = 'guardado-mensaje';
      mensaje.textContent = '‚úÖ Cambios guardados exitosamente';
      document.body.appendChild(mensaje);
      
      setTimeout(() => mensaje.remove(), 3000);
    }

    function obtenerClaseColor(estado) {
      if (!estado) return '';
      if (estado === 'OK') return 'aprobado';
      
      const diferencia = calcularDiferenciaCiclo(estado);
      
      if (diferencia < 0) return 'aprobado';
      else if (diferencia === 0) return 'actual';
      else if (diferencia === 1) return 'proximo';
      else if (diferencia === 2) return 'subsiguiente';
      else return 'futuro';
    }
  </script>
</body>
</html>
