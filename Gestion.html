<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n de Planeamiento de Malla Curricular</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    /* ============================================
       LOGIN SCREEN
       ============================================ */
    .login-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 80vh;
      padding: 40px;
    }

    .login-box {
      background: white;
      padding: 50px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 500px;
      width: 100%;
      text-align: center;
    }

    .login-box h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 2em;
    }

    .login-box p {
      color: #666;
      margin-bottom: 30px;
      font-size: 1.1em;
    }

    .login-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 1.1em;
      text-align: center;
      transition: all 0.3s;
      margin-bottom: 20px;
    }

    .login-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
    }

    .login-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 40px;
      border: none;
      border-radius: 10px;
      font-size: 1.2em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      width: 100%;
    }

    .login-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .error-login {
      background: #ffebee;
      border: 2px solid #f44336;
      color: #c62828;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      font-weight: 600;
    }

    .loading-login {
      color: #667eea;
      padding: 15px;
      font-size: 1.1em;
      margin-top: 20px;
    }

    /* ============================================
       GESTI√ìN SCREEN (oculto inicialmente)
       ============================================ */
    .gestion-screen {
      display: none;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .header p {
      font-size: 1.2em;
      opacity: 0.9;
    }

    .content {
      padding: 40px;
    }

    .section {
      background: #f9f9f9;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      border: 2px solid #e0e0e0;
    }

    .section h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.8em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .btn:active {
      transform: translateY(-1px);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1em;
      transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
    }

    .form-hint {
      font-size: 0.85em;
      color: #666;
      margin-top: 5px;
      font-style: italic;
    }

    .clave-warning {
      background: #fff3cd;
      border: 2px solid #ffc107;
      color: #856404;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 0.9em;
      margin-top: 5px;
      display: none;
    }

    .clave-warning.show {
      display: block;
    }

    .result-box {
      background: #e8f5e9;
      border: 2px solid #4caf50;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
    }

    .result-box.error {
      background: #ffebee;
      border-color: #f44336;
    }

    .result-box h3 {
      color: #2e7d32;
      margin-bottom: 15px;
    }

    .result-box.error h3 {
      color: #c62828;
    }

    .code-display {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin: 15px 0;
      font-family: 'Courier New', monospace;
      font-size: 1.8em;
      font-weight: bold;
      color: #667eea;
      text-align: center;
      border: 3px dashed #667eea;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .btn-secondary {
      background: #4caf50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-secondary:hover {
      background: #45a049;
      transform: translateY(-2px);
    }

    .btn-ir-malla {
      background: #2196f3;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95em;
      transition: all 0.3s;
      margin-top: 10px;
      display: inline-block;
    }

    .btn-ir-malla:hover {
      background: #1976d2;
      transform: translateY(-2px);
    }

    .students-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .students-table th {
      background: #667eea;
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }

    .students-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #e0e0e0;
    }

    .students-table tr:hover {
      background: #f5f5f5;
    }

    .students-table tr:last-child td {
      border-bottom: none;
    }

    .loading {
      text-align: center;
      padding: 30px;
      color: #667eea;
      font-size: 1.2em;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.8em;
      }

      .content {
        padding: 20px;
      }

      .section {
        padding: 20px;
      }

      .btn-group {
        flex-direction: column;
      }

      .students-table {
        font-size: 0.85em;
      }

      .students-table th,
      .students-table td {
        padding: 10px 8px;
      }

      .login-box {
        padding: 30px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ============================================
         PANTALLA DE LOGIN
         ============================================ -->
    <div id="loginScreen" class="login-screen">
      <div class="login-box">
        <h1>üîê Acceso Administrativo</h1>
        <p>Sistema de Gesti√≥n de Malla Curricular</p>
        
        <div style="margin-top: 30px;">
          <label style="display: block; margin-bottom: 8px; color: #333; font-weight: 600;">Clave de Administrador:</label>
          <input type="password" id="claveInput" class="login-input" placeholder="Ingresa la clave">
        </div>
        
        <button class="login-button" onclick="verificarClaveAdmin()">üîì Acceder</button>
        <div id="loginMensaje"></div>
      </div>
    </div>

    <!-- ============================================
         PANTALLA DE GESTI√ìN
         ============================================ -->
    <div id="gestionScreen" class="gestion-screen">
      <div class="header">
        <h1>üéì Sistema de Gesti√≥n de Malla Curricular</h1>
        <p>Administraci√≥n centralizada de planificaci√≥n acad√©mica</p>
      </div>

      <div class="content">
        <!-- Bot√≥n Malla Matriz -->
        <div class="section">
          <h2>üìä Gesti√≥n de Malla Matriz</h2>
          <p style="margin-bottom: 20px; color: #666;">
            Carga y administra las mallas curriculares por instituci√≥n y carrera
          </p>
          <button class="btn" onclick="goToMallaMatriz()">
            üìä Ir a Malla Matriz
          </button>
        </div>

        <!-- Generar Malla para Estudiante -->
        <div class="section">
          <h2>üë§ Generar Malla para Estudiante</h2>
          
          <div class="form-group">
            <label for="nombreEstudiante">Nombre del Estudiante:</label>
            <input type="text" id="nombreEstudiante" placeholder="Ej: Juan P√©rez Garc√≠a">
          </div>

          <div class="form-group">
            <label for="institutoSelect">Instituto:</label>
            <select id="institutoSelect" onchange="cargarCarreras()">
              <option value="">Cargando institutos...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="carreraSelect">Carrera:</label>
            <select id="carreraSelect">
              <option value="">Seleccione primero un instituto</option>
            </select>
          </div>

          <div class="form-group">
            <label for="clavePersonalizada">Clave Personalizada (Opcional):</label>
            <input type="text" id="clavePersonalizada" placeholder="Deja vac√≠o para generar autom√°ticamente" oninput="verificarClaveEstudiante()">
            <div class="form-hint">üí° Si no ingresas una clave, se generar√° autom√°ticamente (6 letras + n√∫mero)</div>
            <div id="claveWarning" class="clave-warning">‚ö†Ô∏è Clave ya existe</div>
          </div>

          <button class="btn" onclick="generarMalla()">
            ‚ú® Generar Malla del Estudiante
          </button>

          <button class="btn-ir-malla" onclick="goToMallaEstudiante()" style="margin-left: 10px;">
            üöÄ Ir a Malla Estudiante
          </button>

          <div id="resultadoGeneracion"></div>
        </div>

        <!-- Consultar Estudiantes -->
        <div class="section">
          <h2>üîç Consultar Estudiantes</h2>
          
          <div class="form-group">
            <label for="filtroNombre">Buscar por Nombre:</label>
            <input type="text" id="filtroNombre" placeholder="Nombre del estudiante">
          </div>

          <div class="form-group">
            <label for="filtroInstituto">Filtrar por Instituto:</label>
            <select id="filtroInstituto" onchange="cargarCarrerasFiltro()">
              <option value="">Todos los institutos</option>
            </select>
          </div>

          <div class="form-group">
            <label for="filtroCarrera">Filtrar por Carrera:</label>
            <select id="filtroCarrera">
              <option value="">Todas las carreras</option>
            </select>
          </div>

          <button class="btn" onclick="consultarEstudiantes()">
            üîç Buscar Estudiantes
          </button>

          <div id="resultadoConsulta"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // VERIFICACI√ìN DE CLAVE ADMIN
    // ============================================
    window.onload = function() {
      document.getElementById('claveInput').focus();
      
      // Manejar Enter en campo de clave
      document.getElementById('claveInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          verificarClaveAdmin();
        }
      });
    };

    function verificarClaveAdmin() {
      const clave = document.getElementById('claveInput').value.trim();
      
      if (!clave) {
        mostrarMensajeLogin('Por favor ingresa la clave', 'error');
        return;
      }

      mostrarMensajeLogin('üîç Verificando...', 'loading');

      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.success) {
            mostrarPantallaGestion();
          } else {
            mostrarMensajeLogin('‚ùå Clave incorrecta', 'error');
            document.getElementById('claveInput').value = '';
            document.getElementById('claveInput').focus();
          }
        })
        .withFailureHandler(function(error) {
          mostrarMensajeLogin('‚ùå Error de conexi√≥n. Intenta de nuevo.', 'error');
        })
        .verificarClaveAdmin(clave);
    }

    function mostrarMensajeLogin(mensaje, tipo) {
      const div = document.getElementById('loginMensaje');
      div.className = tipo === 'error' ? 'error-login' : 'loading-login';
      div.innerHTML = mensaje;
    }

    function mostrarPantallaGestion() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('gestionScreen').style.display = 'block';
      cargarInstitutos();
      cargarInstitutosFiltro();
    }

    // ============================================
    // FUNCIONES DE NAVEGACI√ìN
    // ============================================
    function goToMallaMatriz() {
      google.script.run
        .withSuccessHandler(function(url) {
          window.open(url + '?page=matriz', '_blank');
        })
        .withFailureHandler(function(error) {
          alert('Error al obtener URL: ' + error.message);
        })
        .obtenerUrlApp();
    }

    function goToMallaEstudiante() {
      google.script.run
        .withSuccessHandler(function(url) {
          window.open(url + '?page=estudiante', '_blank');
        })
        .withFailureHandler(function(error) {
          alert('Error al obtener URL: ' + error.message);
        })
        .obtenerUrlApp();
    }

    // ============================================
    // CARGAR INSTITUTOS Y CARRERAS
    // ============================================
    function cargarInstitutos() {
      google.script.run
        .withSuccessHandler(function(institutos) {
          const select = document.getElementById('institutoSelect');
          select.innerHTML = '<option value="">Seleccione un instituto</option>';
          institutos.forEach(inst => {
            select.innerHTML += '<option value="' + inst + '">' + inst + '</option>';
          });
        })
        .withFailureHandler(function(error) {
          alert('Error al cargar institutos: ' + error.message);
        })
        .obtenerInstitutos();
    }

    function cargarCarreras() {
      const instituto = document.getElementById('institutoSelect').value;
      const selectCarrera = document.getElementById('carreraSelect');
      
      if (!instituto) {
        selectCarrera.innerHTML = '<option value="">Seleccione primero un instituto</option>';
        return;
      }

      selectCarrera.innerHTML = '<option value="">Cargando carreras...</option>';

      google.script.run
        .withSuccessHandler(function(carreras) {
          selectCarrera.innerHTML = '<option value="">Seleccione una carrera</option>';
          carreras.forEach(carrera => {
            selectCarrera.innerHTML += '<option value="' + carrera + '">' + carrera + '</option>';
          });
        })
        .withFailureHandler(function(error) {
          alert('Error al cargar carreras: ' + error.message);
        })
        .obtenerCarrerasPorInstituto(instituto);
    }

    function cargarInstitutosFiltro() {
      google.script.run
        .withSuccessHandler(function(institutos) {
          const select = document.getElementById('filtroInstituto');
          select.innerHTML = '<option value="">Todos los institutos</option>';
          institutos.forEach(inst => {
            select.innerHTML += '<option value="' + inst + '">' + inst + '</option>';
          });
        })
        .obtenerInstitutos();
    }

    function cargarCarrerasFiltro() {
      const instituto = document.getElementById('filtroInstituto').value;
      const selectCarrera = document.getElementById('filtroCarrera');
      
      if (!instituto) {
        selectCarrera.innerHTML = '<option value="">Todas las carreras</option>';
        return;
      }

      selectCarrera.innerHTML = '<option value="">Cargando carreras...</option>';

      google.script.run
        .withSuccessHandler(function(carreras) {
          selectCarrera.innerHTML = '<option value="">Todas las carreras</option>';
          carreras.forEach(carrera => {
            selectCarrera.innerHTML += '<option value="' + carrera + '">' + carrera + '</option>';
          });
        })
        .obtenerCarrerasPorInstituto(instituto);
    }

    // ============================================
    // VERIFICAR CLAVE ESTUDIANTE
    // ============================================
    function verificarClaveEstudiante() {
      const clave = document.getElementById('clavePersonalizada').value.trim();
      const warning = document.getElementById('claveWarning');
      
      if (!clave) {
        warning.classList.remove('show');
        return;
      }

      google.script.run
        .withSuccessHandler(function(existe) {
          if (existe) {
            warning.classList.add('show');
          } else {
            warning.classList.remove('show');
          }
        })
        .verificarCodeExiste(clave);
    }

    // ============================================
    // GENERAR MALLA PARA ESTUDIANTE
    // ============================================
    function generarMalla() {
      const nombre = document.getElementById('nombreEstudiante').value.trim();
      const instituto = document.getElementById('institutoSelect').value;
      const carrera = document.getElementById('carreraSelect').value;
      const clavePersonalizada = document.getElementById('clavePersonalizada').value.trim();

      if (!nombre) {
        alert('Por favor ingrese el nombre del estudiante');
        return;
      }

      if (!instituto) {
        alert('Por favor seleccione un instituto');
        return;
      }

      if (!carrera) {
        alert('Por favor seleccione una carrera');
        return;
      }

      const resultado = document.getElementById('resultadoGeneracion');
      resultado.innerHTML = '<div class="loading">‚è≥ Generando malla del estudiante...</div>';

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            resultado.innerHTML = '<div class="result-box"><h3>‚úÖ Malla Generada Exitosamente</h3><p><strong>Estudiante:</strong> ' + nombre + '</p><p><strong>Instituto:</strong> ' + instituto + '</p><p><strong>Carrera:</strong> ' + carrera + '</p><p style="margin-top: 20px; font-weight: 600;">üîë C√≥digo de Estudiante:</p><div class="code-display">' + result.code + '</div><p style="font-size: 0.9em; color: #666; margin-top: 5px; text-align: center;">‚ö†Ô∏è El estudiante debe guardar este c√≥digo para acceder a su malla</p><div class="btn-group"><button class="btn-secondary" onclick="copiarCodigo(\'' + result.code + '\')">üìã Copiar C√≥digo</button></div></div>';
            
            document.getElementById('nombreEstudiante').value = '';
            document.getElementById('clavePersonalizada').value = '';
            document.getElementById('claveWarning').classList.remove('show');
            
          } else if (result.claveExiste) {
            resultado.innerHTML = '<div class="result-box error"><h3>‚ùå Clave Ya Existe</h3><p>' + result.message + '</p><p style="margin-top: 10px; font-size: 0.95em;">Por favor ingresa otra clave o deja el campo vac√≠o para generar una autom√°ticamente.</p></div>';
          } else {
            resultado.innerHTML = '<div class="result-box error"><h3>‚ùå Error al Generar Malla</h3><p>' + result.message + '</p></div>';
          }
        })
        .withFailureHandler(function(error) {
          resultado.innerHTML = '<div class="result-box error"><h3>‚ùå Error de Conexi√≥n</h3><p>' + error.message + '</p></div>';
        })
        .generarMallaEstudiante(nombre, instituto, carrera, clavePersonalizada);
    }

    function copiarCodigo(codigo) {
      navigator.clipboard.writeText(codigo).then(function() {
        alert('‚úÖ C√≥digo copiado al portapapeles: ' + codigo);
      }).catch(function(err) {
        alert('‚ùå Error al copiar: ' + err);
      });
    }

    // ============================================
    // CONSULTAR ESTUDIANTES
    // ============================================
    function consultarEstudiantes() {
      const nombre = document.getElementById('filtroNombre').value.trim();
      const instituto = document.getElementById('filtroInstituto').value;
      const carrera = document.getElementById('filtroCarrera').value;

      const resultado = document.getElementById('resultadoConsulta');
      resultado.innerHTML = '<div class="loading">üîç Buscando estudiantes...</div>';

      google.script.run
        .withSuccessHandler(function(estudiantes) {
          if (estudiantes.length === 0) {
            resultado.innerHTML = '<div class="result-box error"><h3>üì≠ No se encontraron estudiantes</h3><p>No hay estudiantes que coincidan con los criterios de b√∫squeda.</p></div>';
            return;
          }

          let html = '<div class="result-box"><h3>üìä Resultados de la B√∫squeda (' + estudiantes.length + ' estudiante(s) - ordenados alfab√©ticamente)</h3><table class="students-table"><thead><tr><th>Nombre</th><th>Instituto</th><th>Carrera</th><th>Clave</th></tr></thead><tbody>';

          estudiantes.forEach(function(est) {
            html += '<tr><td><strong>' + est.nombre + '</strong></td><td>' + est.instituto + '</td><td>' + est.carrera + '</td><td><code style="background: #e3f2fd; color: #1976d2; padding: 6px 12px; border-radius: 6px; font-weight: bold; font-size: 1.05em;">' + est.code + '</code></td></tr>';
          });

          html += '</tbody></table></div>';

          resultado.innerHTML = html;
        })
        .withFailureHandler(function(error) {
          resultado.innerHTML = '<div class="result-box error"><h3>‚ùå Error de Conexi√≥n</h3><p>' + error.message + '</p></div>';
        })
        .consultarEstudiantes(nombre, instituto, carrera);
    }
  </script>
</body>
</html>
